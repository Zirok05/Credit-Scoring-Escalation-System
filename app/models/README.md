# 🧠 Логика эскалации и интерпретации (app/models/)

Папка содержит ключевую бизнес-логику приложения: многоуровневую эскалацию заявок и интерпретацию решений моделей.

## 📁 Структура
```
models/
├── escalation.py # Бизнес-правила + эскалация между моделями
└── interpretation.py # Интерпретация (LR + SHAP)
```

## 📄 Описание файлов

### `escalation.py` - Эскалационная система

Реализует многоуровневую обработку заявок:
```
                                ┌─────────────────┐
                                │    Анкета       │
                                └────────┬────────┘
                                         │
                                ┌────────▼────────┐
                                │ Бизнес-правила  │
                                └────────┬────────┘
                                         │
                ┌────────────────────────┼────────────────────────┐
                │                        │                        │
     ┌──────────▼──────────┐    ┌────────▼────────┐    ┌──────────▼────────────┐
     │ Коды 96/98          │    │ Возраст < 18    │    │ Все проверки пройдены │
     │ Возраст > 80        │    └────────┬────────┘    └──────────┬────────────┘
     │ Доход > 1M$         │             │                        │
     │ Utilization > 200%  │    ┌────────▼───────┐     ┌──────────▼──────────┐
     │ и др.               │    │   Авто-отказ   │     │ Logistic Regression │
     └──────────┬──────────┘    └────────────────┘     └──────────┬──────────┘
                │                                                 │
     ┌──────────▼────────┐                             ┌──────────┴───────────┐
     │  Ручной разбор    │                      ┌──────▼──────┐        ┌──────▼──────┐
     │    экспертами     │                      │  Уверена    │        │ Не уверена  │
     └──────────┬────────┘                      └──────┬──────┘        └──────┬──────┘
                │                                      │                      │
     ┌──────────▼──────────┐                      ┌────▼─────┐     ┌──────────▼──────────┐
     │  Одобрение / Отказ  │                      │ Одобрено │     │  Сложная модель     │
     │  (решение человека) │                      └──────────┘     └──────────┬──────────┘
     └─────────────────────┘                                                  │
                                                                      ┌───────┴─────────┐
                                                               ┌──────▼──────┐   ┌──────▼──────┐
                                                               │  Уверена    │   │ Не уверена  │
                                                               └──────┬──────┘   └──────┬──────┘
                                                                      │                 │
                                                                 ┌────▼────┐   ┌────────▼────────┐
                                                                 │ Одобрено│   │  Ручной разбор  │
                                                                 └─────────┘   │    экспертами   │
                                                                               └────────┬────────┘
                                                                                        │
                                                                               ┌────────▼────────┐
                                                                               │ Одобрение/Отказ │
                                                                               └─────────────────┘
```                                           
#### Основные функции:

**1. `check_business_rules(df)`** - батчевая проверка бизнес-правил
- Возраст < 18 → автоматический отказ
- Коды 96/98 в просрочках → ручной разбор
- Возраст > 80, доход > 1M$, долг > 1M$ → ручной разбор
- Utilization > 200% → ручной разбор
- Недвижимость > 20 кредитов → ручной разбор
- и др.

**2. `escalation_decision(applications_df, lr_model, second_model, second_model_name, ...)`** - главная функция эскалации

**Алгоритм работы:**
1. Применяет бизнес-правила ко всем заявкам
2. Заявки, прошедшие правила, отправляются в `Logistic Regression`
3. Если LR "уверена" (вне серой зоны) → финальное решение
4. Если LR "не уверена" → заявка идет во вторую модель
5. Если вторая модель "уверена" → финальное решение
6. Если обе модели "не уверены" → ручной разбор

**"Серая зона"** определяется отступами от порога:
- Для положительных предсказаний: `margin = proba - threshold`
- Для отрицательных: `margin = threshold - proba`
- Заявка уверенна, если `margin >= отступ`

### `interpretation.py` - Интерпретация моделей

Функции для объяснения решений пользователю.

#### Для Logistic Regression:

**`interpret_lr(features, lr_model, feature_names)`**
Возвращает:
- `logit_contributions` - вклад каждого признака в логит (коэффициент × значение)
- `marginal_effects` - изменение вероятности при обнулении признака
- Итоговую вероятность и логит

**`plot_feature_importance_sns()`** - визуализация вклада в логит
**`plot_marginal_effects_sns()`** - визуализация влияния на вероятность

#### Для сложных моделей (tree-based):

**`plot_shap_analysis(second_model, processed_scaled, feature_names, second_model_name)`**
- SHAP-анализ для `XGBoost`/`LightGBM`/`CatBoost`/`Random Forest`
- **Waterfall plot** (как признаки влияют на конкретное предсказание)
- Таблица с `SHAP` значениями
- Группировка факторов (повышают/снижают риск)

**`get_feature_display_name(feature_name)`** - переводит технические названия признаков в понятные пользователю:   
- `RevolvingUtilizationOverOne` → "Использование > 100%"  
- `DebtPayments_over_10k` → "Платежи > 10k$"  
  
## 🎯 Как это работает вместе

1. **Эскалация** (`escalation.py`) получает заявку и возвращает решение  
2. **Интерпретация** (`interpretation.py`) объясняет, почему такое решение  

```python
# Пример из application.py
decision, manual_mask, stats = escalation_decision(...)

if not decision['needs_review']:
    # Показываем интерпретацию
    if decision['model_used'] == 'Logistic Regression':
        interpretation = interpret_lr(processed_scaled, lr_model, feature_names)
        plot_feature_importance_sns(interpretation['logit_contributions'])
    else:
        plot_shap_analysis(second_model, processed_scaled, feature_names, second_model_name)
```
## 🔧 Используется в

`pages/application.py` - основная логика обработки анкет  
`simulation/core/processor.py` - батчевая обработка в симуляции  

📚 Подробнее
[Страницы приложения](../pages/README.md)
[Симуляция](../simulation/README.md)
[Утилиты](../utils/README.md)
