# üéõ –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã (simulation/controllers/)

–ü–∞–ø–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–µ–≥—É–ª—è—Ç–æ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã –≤ —Å–∏–º—É–ª—è—Ü–∏–∏.   

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞
```
controllers/
‚îú‚îÄ‚îÄ base.py # –ë–∞–∑–æ–≤—ã–π –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
‚îî‚îÄ‚îÄ pid.py # PID-—Ä–µ–≥—É–ª—è—Ç–æ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç—Å—Ç—É–ø–∞–º–∏ –º–æ–¥–µ–ª–µ–π
```

## üìÑ –û–ø–∏—Å–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤

### `base.py` - –ë–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä

–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤.

```python
from abc import ABC, abstractmethod

class BaseController(ABC):
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤"""
    
    def __init__(self, name="Base"):
        self.name = name
        self.history = []

    @abstractmethod
    def update(self, current_state, target_state):
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"""
        pass

    def get_margins(self, hour=None):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –æ—Ç—Å—Ç—É–ø—ã"""
        pass
```
### `pid.py` - PID-—Ä–µ–≥—É–ª—è—Ç–æ—Ä

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è PID-—Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞ (–ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ-–ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–æ-–î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ) –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—Å—Ç—É–ø–æ–≤ –º–æ–¥–µ–ª–µ–π.  
 
#### –ó–∞—á–µ–º –Ω—É–∂–µ–Ω:

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ü–µ–ª–µ–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 80%), –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≥—É–ª–∏—Ä—É—è "—Å–µ—Ä—É—é –∑–æ–Ω—É" –º–æ–¥–µ–ª–µ–π:   
  
- –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –≤—ã—Å–æ–∫–∞—è ‚Üí —Å—É–∂–∞–µ—Ç –æ—Ç—Å—Ç—É–ø—ã (–º–µ–Ω—å—à–µ –∑–∞—è–≤–æ–∫ —É—Ö–æ–¥–∏—Ç –≤ —Ä—É—á–Ω–æ–π —Ä–∞–∑–±–æ—Ä)  
- –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∏–∑–∫–∞—è ‚Üí —Ä–∞—Å—à–∏—Ä—è–µ—Ç –æ—Ç—Å—Ç—É–ø—ã (–±–æ–ª—å—à–µ –∑–∞—è–≤–æ–∫ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –ª—é–¥–∏)  
  
**–ö–ª–∞—Å—Å `PIDController`:**
```
python
class PIDController(BaseController):
    def __init__(self, name="PID",
                 kp_load=0.1, ki_load=0.01, kd_load=0.05,  # –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã PID
                 load_weight=1.0,                           # –≤–µ—Å –∑–∞–≥—Ä—É–∑–∫–∏
                 init_threshold=0.5,                         # –ø–æ—Ä–æ–≥ –æ–¥–æ–±—Ä–µ–Ω–∏—è
                 init_lr_low=0.3, init_lr_high=0.4,          # –Ω–∞—á–∞–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã LR
                 init_second_low=0.35, init_second_high=0.45, # –Ω–∞—á–∞–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –≤—Ç–æ—Ä–æ–π –º–æ–¥–µ–ª–∏
                 target_load=0.8):                            # —Ü–µ–ª–µ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
```
**–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥:**
```
python
def update(self, current_load):
    """
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ–∫—É—â—É—é –∑–∞–≥—Ä—É–∑–∫—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ (0-1)
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–µ –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –º–æ–¥–µ–ª–µ–π
    """
    # –û—à–∏–±–∫–∞ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è (—Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Ü–µ–ª–µ–≤–æ–π –∏ —Ç–µ–∫—É—â–µ–π –∑–∞–≥—Ä—É–∑–∫–æ–π)
    error_load = self.target_load - current_load
    
    # –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è (P)
    P_load = self.kp_load * error_load
    
    # –ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è (I) - –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏
    self.integral_load += error_load
    I_load = self.ki_load * self.integral_load
    
    # –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è (D) - —Å–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—à–∏–±–∫–∏
    D_load = self.kd_load * (error_load - self.prev_error_load)
    self.prev_error_load = error_load
    
    # –í—ã—Ö–æ–¥ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞
    output_load = P_load + I_load + D_load
    output = self.load_weight * output_load
    
    # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –æ—Ç—Å—Ç—É–ø—ã
    self._update_parameters(output)
```

#### –ö–∞–∫ –º–µ–Ω—è—é—Ç—Å—è –æ—Ç—Å—Ç—É–ø—ã:
```
python
def _update_parameters(self, output):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –æ—Ç—Å—Ç—É–ø—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã—Ö–æ–¥–∞ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞"""
    delta = output * 0.1
    self.lr_low = np.clip(self.lr_low + delta, self.bounds['lr_low'][0], self.bounds['lr_low'][1])
    self.lr_high = np.clip(self.lr_high + delta, self.bounds['lr_high'][0], self.bounds['lr_high'][1])
    self.second_low = np.clip(self.second_low + delta, self.bounds['second_low'][0], self.bounds['second_low'][1])
    self.second_high = np.clip(self.second_high + delta, self.bounds['second_high'][0], self.bounds['second_high'][1])
```
#### –ì—Ä–∞–Ω–∏—Ü—ã –æ—Ç—Å—Ç—É–ø–æ–≤:

–û—Ç—Å—Ç—É–ø—ã –Ω–µ –º–æ–≥—É—Ç —É–π—Ç–∏ –≤ –Ω–æ–ª—å –∏–ª–∏ —Å—Ç–∞—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏:  
```
python
self.bounds = {
    'lr_low': (0.05, self.threshold - 0.05),       # –Ω–∏–∂–Ω–∏–π –æ—Ç—Å—Ç—É–ø LR
    'lr_high': (0.05, 1 - self.threshold - 0.05),  # –≤–µ—Ä—Ö–Ω–∏–π –æ—Ç—Å—Ç—É–ø LR
    'second_low': (0.05, self.threshold - 0.05),    # –Ω–∏–∂–Ω–∏–π –æ—Ç—Å—Ç—É–ø –≤—Ç–æ—Ä–æ–π –º–æ–¥–µ–ª–∏
    'second_high': (0.05, 1 - self.threshold - 0.05) # –≤–µ—Ä—Ö–Ω–∏–π –æ—Ç—Å—Ç—É–ø –≤—Ç–æ—Ä–æ–π –º–æ–¥–µ–ª–∏
}
```
#### –ò—Å—Ç–æ—Ä–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:
```
python
def get_history(self):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç DataFrame —Å –∏—Å—Ç–æ—Ä–∏–µ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π"""
    return pd.DataFrame(self.history)
```
–í –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:  
- `time` - –º–∏–Ω—É—Ç–∞ —Å–∏–º—É–ª—è—Ü–∏–∏  
- `error_load` - –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏  
- `output` - –≤—ã—Ö–æ–¥ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞  
- `lr_low`, `lr_high` - –æ—Ç—Å—Ç—É–ø—ã `LR`  
- `second_low`, `second_high` - –æ—Ç—Å—Ç—É–ø—ã –≤—Ç–æ—Ä–æ–π –º–æ–¥–µ–ª–∏  
- `load` - —Ç–µ–∫—É—â–∞—è –∑–∞–≥—Ä—É–∑–∫–∞  

### üéØ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –≤ —Å–∏–º—É–ª—è—Ü–∏–∏

–ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É:  
1. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∑–∞–≥—Ä—É–∑–∫—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –∏–∑ `processor.py`  
2. –í—ã–∑—ã–≤–∞–µ–º `pid.update(current_load)`  
3. –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–µ –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –º–æ–¥–µ–ª–µ–π  
4. –ü–µ—Ä–µ–¥–∞–µ–º –∏—Ö –≤ `escalation_decision()` –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –º–∏–Ω—É—Ç—É  

### üîß –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤

`pages/simulation.py` - –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Å–∏–º—É–ª—è—Ü–∏–∏  
`simulation/visualization/plots.py` - –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ PID  

üìö –ü–æ–¥—Ä–æ–±–Ω–µ–µ  
[–Ø–¥—Ä–æ —Å–∏–º—É–ª—è—Ü–∏–∏](../core/README.md)  
[–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è](../visualization/README.md)  
[–ú–æ–¥–µ–ª—å —ç—Å–∫–∞–ª–∞—Ü–∏–∏](../../models/README.md)  
